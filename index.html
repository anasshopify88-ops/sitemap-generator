<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover"/>
<title>آداة منشئ خريطة الموقع (Sitemap) المجانية</title>

<!-- خط عربي جميل -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    /* ثيم وفونت بنفس الأداة الأولى */
    --bg:#f7f8fb; --bg-2:#f1f5fb; --card:#ffffff; --text:#0c1424; --muted:#5b6472; --accent:#2563eb;
    --ok:#15803d; --warn:#d97706; --error:#dc2626; --border:#e6e9f2; --shadow:0 6px 16px rgba(0,0,0,.08);
    --radius:16px; --radius-sm:12px;

    /* عرض العمود */
    --sidebar-w:280px;

    /* أحجام أصغر */
    --fs-base:13px; --fs-sm:11.5px; --fs-xs:10.5px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Cairo",system-ui,Arial,Helvetica,sans-serif; line-height:1.65;
    background:linear-gradient(180deg,var(--bg),var(--bg-2)); color:var(--text);
    -webkit-font-smoothing:antialiased; overflow-x:hidden; font-size:var(--fs-base);
  }

  .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 64px}

  /* التوب بار */
  .topbar{display:flex;align-items:center;gap:8px;margin-bottom:12px}
  .btn{
    border:1px solid var(--border); background:linear-gradient(180deg,#fff,#f9fbff);
    color:var(--text); padding:8px 12px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow:var(--shadow);
    transition:transform .18s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
    font-size:12px; text-decoration:none; display:inline-flex; align-items:center; gap:6px;
  }
  .btn:hover{transform:translateY(-2px); border-color:#cbd5e1}
  .btn.primary{background:linear-gradient(135deg,#2563eb,#8b5cf6); color:#fff; border-color:transparent}
  .btn.ok{background:linear-gradient(135deg,#16a34a,#22c55e); color:#fff; border-color:transparent}
  .btn.home{background:#000; color:#fff; border-color:#000}
  .btn:disabled{opacity:.6; cursor:not-allowed}

  /* بطاقات */
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}

  /* عنوان الصفحة */
  .titleRow{display:flex;align-items:center;gap:10px;justify-content:space-between}
  h1{margin:0;font-size:clamp(18px,2.2vw,24px);font-weight:800;letter-spacing:.2px}
  .sub{margin-top:6px;color:var(--muted);font-size:var(--fs-sm)}
  .notice{margin-top:6px;font-size:12px;color:var(--error)}
  .notice a{color:var(--error);text-decoration:underline}

  /* التخطيط العام: سايدبار يسار + الأداة يمين */
  .layout{
    display:grid;
    grid-template-columns: var(--sidebar-w) 1fr;
    gap:14px;
    align-items:stretch; /* يساوي الارتفاع */
  }

  /* السايدبار بطول الأداة */
  #sidePanel{
    display:flex;
    height:100%;
    min-height:0;
    overflow:hidden; /* المحتوى الداخلي يتسكرول داخل البطاقة */
  }
  @media (min-width:981px){
    #sidePanel{ contain:size; } /* يمنع تضخيم الصف */
  }
  .sidebar-card{
    flex:1 1 auto;
    height:100%;
    display:flex; flex-direction:column; gap:10px; min-height:0; overflow:auto;
  }
  .avatar{width:112px;height:112px;border-radius:50%;background:#fff;padding:6px;object-fit:contain;object-position:center;border:1px solid var(--border);align-self:center}
  .logo{width:100%; max-width:180px; align-self:center; object-fit:contain; object-position:center; background:#fff; border-radius:12px; border:1px solid var(--border); padding:8px}
  /* تخصيص الشعار في صف العنوان ليحافظ على نفس الحجم الحالي */
  .title-logo{width:180px; max-width:180px; align-self:center}

  .s-list{display:grid; gap:8px}
  .s-item a{
    display:block; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#fff;
    color:#0f172a; text-decoration:none; font-weight:600; transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    box-shadow:0 4px 12px rgba(15,23,42,.05); font-size:13px;
  }
  .s-item a:hover{transform:translateY(-2px); border-color:#cbd5e1; box-shadow:0 8px 18px rgba(15,23,42,.08)}
  .s-caption{color:var(--muted); font-size:11.5px; margin-top:-2px; align-self:center}

  /* يمين: صندوق الأداة */
  #toolBox{display:flex; flex-direction:column; gap:10px; min-height:0}

  /* عناصر الأداة (أعدنا تنسيقها لتبدو كبطاقات) */
  .panel.card label{display:block; font-size:14px; margin-bottom:6px}
  textarea{
    width:100%; background:#fff; color:var(--text); border:1px solid var(--border);
    border-radius:12px; padding:10px 12px; outline:none;
    min-height:140px; resize:vertical; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; line-height:1.55
  }
  input[type="file"]{
    width:100%; background:#fff; color:var(--text); border:1px solid var(--border);
    border-radius:12px; padding:10px 12px; outline:none;
  }
  textarea:focus,input[type="file"]:focus{box-shadow:0 0 0 3px rgba(37,99,235,.25)}

  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .grid{display:grid; gap:10px}

  .summary{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px}
  .card-mini{background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px}
  .card-mini .k{font-size:12px; color:var(--muted)}
  .card-mini .v{font-weight:800; font-size:18px}

  .code{
    background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; overflow:auto;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space:pre; line-height:1.5; max-height:300px;
  }
  .hl .tag{color:#0ea5e9}
  .hl .attr{color:#ef4444}
  .hl .val{color:#059669}
  .hl .cm{color:#94a3b8}

  .links-list a{display:inline-block; margin:.2rem .4rem; font-size:13px}
  .errors{background:#fff1f2; border:1px solid #fecdd3; color:#b91c1c; border-radius:12px; padding:10px; margin-top:8px; display:none}
  .drop{
    border:2px dashed var(--border); border-radius:12px; padding:14px; text-align:center; color:#94a3b8;
  }
  .drop.drag{border-color:#06b6d4; background:#f0fdff; color:#0e7490}

  /* استجابة */
  @media (max-width:980px){
    .layout{grid-template-columns:1fr}
    #sidePanel{height:auto; overflow:visible;}
    .avatar{width:104px;height:104px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- توب بار -->
    <nav class="topbar">
      <button class="btn" type="button" onclick="history.back()">رجوع</button>
      <a class="btn home" href="https://anasrashed.com" rel="noopener">الرئيسية</a>
    </nav>

    <!-- عنوان -->
    <div class="card">
      <div class="titleRow">
        <div>
          <h1>آداة منشئ خريطة الموقع (Sitemap) المجانية</h1>
          <p class="notice">اذا باقتك بلس، اطلب خدمة تفعيل خريطة الموقع في Google Search Console <a href="https://anasrashed.com/ZqyGaBZ" rel="noopener">من هنا</a></p>
        </div>
        <!-- الشعار منقول إلى يسار العنوان -->
        <img class="logo title-logo" src="https://i.imgur.com/meUEoP7.png" alt="الشعار"
             onerror="this.onerror=null; this.src='https://i.imgur.com/meUEoP7.jpg';">
      </div>
    </div>

    <!-- التخطيط: السايدبار يسار + الأداة يمين -->
    <div class="layout" style="margin-top:12px">
      <!-- العمود الأيسر -->
      <aside id="sidePanel">
        <div class="card sidebar-card">
          <img class="avatar" src="https://i.imgur.com/B3UkEQ0.jpg" alt="صورتي" referrerpolicy="no-referrer"
               onerror="this.onerror=null; this.src='https://i.imgur.com/B3UkEQ0.png';">
          <div class="s-list">
            <div class="s-item"><a href="https://whoami.anasrashed.com" target="_blank" rel="noopener">من أنا؟</a></div>
            <div class="s-item"><a href="https://anasrashed.com/wAXpVym" target="_blank" rel="noopener">دليل السيو الشامل</a></div>
            <div class="s-item"><a href="https://anasrashed.com/eQvbbqP" target="_blank" rel="noopener">أفضل باك لينك</a></div>
            <div class="s-item"><a href="https://anasrashed.com/NApDQYD" target="_blank" rel="noopener">حملة باك لينك شهرية</a></div>
            <div class="s-item"><a href="https://anasrashed.com/ZqyGaBZ" target="_blank" rel="noopener">حل مشكلة خريطة الموقع للباقة بلس</a></div>
            <div class="s-item"><a href="https://serp.anasrashed.com" target="_blank" rel="noopener">أداة SERP بالذكاء الإصطناعي</a></div>
            <div class="s-item"><a href="https://smg.anasrashed.com" target="_blank" rel="noopener">أداة منشئ خريطة الموقع</a></div>
            <div class="s-item"><a href="https://anasrashed.com/blog" target="_blank" rel="noopener">تعلم أكثر</a></div>
            <div class="s-item"><a href="https://anasrashed.com/توثيق-التجارة-الإلكترونية/page-1494027497" target="_blank" rel="noopener">توثيق التجارة الإلكترونية</a></div>
            <div class="s-item"><a href="https://contact.anasrashed.com" target="_blank" rel="noopener">تواصل معي</a></div>
          </div>
          <!-- تم إزالة الشعار من هنا بعد نقله لصف العنوان -->
        </div>
      </aside>

      <!-- يمين: الأداة -->
      <section id="toolBox">
        <!-- إدخال -->
        <section class="panel card">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <label for="txtLinks" style="margin:0">ألصق الروابط</label>
            <div class="row">
              <button id="btnClear" class="btn" type="button">مسح</button>
            </div>
          </div>

          <textarea id="txtLinks" placeholder="اضف روابطك هنا."></textarea>

          <div class="grid" style="margin-top:10px">
            <div>
              <label for="fileInput">أو ارفع CSV/JSON</label>
              <input id="fileInput" type="file" accept=".csv,.json,application/json,text/csv"/>
              <div id="drop" class="drop" style="margin-top:8px">اسحب وأفلِت الملف هنا أو انقر للاختيار</div>
            </div>
          </div>
        </section>

        <!-- المعاينة والتنزيل -->
        <section class="panel card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:6px 0 10px">المعاينة</h3>
            <div class="row">
              <button id="btnCopyIndex" class="btn primary" type="button" disabled>نسخ sitemap_index.xml</button>
              <button id="btnZip" class="btn ok" type="button" disabled>تنزيل جميع الخرائط كـ ZIP</button>
            </div>
          </div>

          <div class="summary">
            <div class="card-mini"><div class="k">الروابط بعد التنظيف</div><div id="sumCount" class="v">0</div></div>
            <div class="card-mini"><div class="k">عدد ملفات الخرائط</div><div id="sumFiles" class="v">0</div></div>
            <div class="card-mini"><div class="k">الحجم التقريبي</div><div id="sumSize" class="v">0 KB</div></div>
          </div>

          <div class="grid" style="margin-top:10px">
            <div>
              <label>مقتطف XML</label>
              <div id="code" class="code hl" aria-live="polite"></div>
            </div>
            <div>
              <div id="links" class="links-list">لا يوجد ملفات بعد.</div>
              <div id="errors" class="errors" role="alert"></div>
            </div>
          </div>
        </section>
      </section>
    </div>
  </div>

<script>
/* -------- إعداد صورة Imgur (بدون قص) — يُستخدم في السايدبار بالأساس -------- */
(function initAvatarFallback(){
  const img = document.querySelector('.avatar');
  if(!img) return;
})();

/* ================= منطق الأداة (بدون تغيير في الإعدادات/السلوك) ================= */
const $ = s=>document.querySelector(s);
const toBytes = s => new TextEncoder().encode(s);
const escapeXml = s => String(s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');

const txtLinks = $('#txtLinks');
const fileInput = $('#fileInput');
const drop = $('#drop');
const btnClear = $('#btnClear');
const btnZip = $('#btnZip');
const btnCopyIndex = $('#btnCopyIndex');
const sumCount = $('#sumCount');
const sumFiles = $('#sumFiles');
const sumSize = $('#sumSize');
const code = $('#code');
const links = $('#links');
const errorsBox = $('#errors');

let debounceTimer=null;
const debounce = (fn,ms=150)=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(fn,ms); };

txtLinks.addEventListener('input', ()=> debounce(updateAll));
btnClear.addEventListener('click', ()=>{ txtLinks.value=''; delete txtLinks.dataset.uploadContent; delete txtLinks.dataset.uploadName; updateAll(); });

/* ---- رفع CSV/JSON ---- */
fileInput.addEventListener('change', e=> handleFiles(e.target.files));
['dragenter','dragover'].forEach(ev=>{
  drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag');});
});
['dragleave','drop'].forEach(ev=>{
  drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');});
});
drop.addEventListener('click', ()=> fileInput.click());
drop.addEventListener('drop', e=> handleFiles(e.dataTransfer.files));

function handleFiles(files){
  if(!files || !files.length) return;
  const f = files[0];
  const r = new FileReader();
  r.onload = ()=>{ txtLinks.dataset.uploadContent = r.result; txtLinks.dataset.uploadName = f.name.toLowerCase(); updateAll(); };
  r.readAsText(f);
}

/* ---- CSV Parser ---- */
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
  const rows=[]; let row=[], cur='', inQ=false;
  const pushCell=()=>{row.push(cur);cur='';}, pushRow=()=>{rows.push(row);row=[];};
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQ){
      if(ch=='"'){ if(text[i+1]=='"'){cur+='"'; i++;} else inQ=false; }
      else cur+=ch;
    }else{
      if(ch=='"') inQ=true;
      else if(ch==',') pushCell();
      else if(ch=='\r'){}
      else if(ch=='\n'){ pushCell(); pushRow(); }
      else cur+=ch;
    }
  }
  pushCell(); pushRow();
  if(rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==='') rows.pop();
  if(!rows.length) return [];
  const headers = rows[0].map(h=>h.trim().toLowerCase());
  const out=[];
  for(let r=1;r<rows.length;r++){
    const obj={};
    for(let c=0;c<headers.length;c++){ obj[headers[c]] = (rows[r][c] ?? '').trim(); }
    out.push(obj);
  }
  return out;
}

/* ---- Helpers ---- */
function resolveUrl(u){
  u=(u||'').trim(); if(!u) return null;
  const m = u.match(/\s#.*$/); if(m) u = u.slice(0, m.index).trim();
  if(/^https?:\/\//i.test(u)) return u;
  return null;
}

/* ---- Parse inputs (url فقط، وchangefreq إن وُجد) ---- */
function parseInputs(){
  const errs = [];
  let recs=[];

  const upText = txtLinks.dataset.uploadContent;
  const upName = (txtLinks.dataset.uploadName||'').toLowerCase();

  if(upText){
    if(upName.endsWith('.json')){
      try{
        const arr = JSON.parse(upText);
        if(!Array.isArray(arr)) throw new Error('JSON يجب أن يكون مصفوفة كائنات');
        recs = arr.map(x=>({ url: x.url ?? '', changefreq: x.changefreq ?? '' }));
      }catch(e){ errs.push('تعذّر قراءة JSON: '+e.message); }
    }else{
      try{
        const rows = parseCSV(upText);
        if(!rows.length) errs.push('الملف CSV فارغ.');
        const hasUrl = rows.length && ('url' in rows[0]);
        if(!hasUrl) errs.push('CSV يجب أن يحتوي عمود url.');
        recs = rows.map(r=>({ url: r.url || '', changefreq: r.changefreq || '' }));
      }catch{ errs.push('تعذّر قراءة CSV.'); }
    }
  }else{
    const lines = txtLinks.value.split(/\r?\n/);
    recs = lines.map(x=>({url:x}));
  }

  // تنظيف + إزالة مكررات
  const seen = new Set(); const out=[];
  for(const r of recs){
    let u = resolveUrl(r.url); if(!u) continue;

    // إزالة utm_* دائمًا
    try{
      const uo = new URL(u); const p=uo.searchParams; const del=[];
      p.forEach((v,k)=>{ if(k.toLowerCase().startsWith('utm_')) del.push(k); });
      del.forEach(k=>p.delete(k)); uo.search=p.toString(); u = uo.toString();
    }catch{}

    if(seen.has(u)) continue; seen.add(u);
    out.push({ url:u, changefreq: r.changefreq || 'daily' });
  }
  return {records: out, errors: errs};
}

/* ---- Build Sitemaps (بدون alternates/images/priority/lastmod) ---- */
function buildSitemaps(){
  const {records, errors} = parseInputs();
  const CHUNK = 50000;
  const chunks = [];
  for(let i=0;i<records.length;i+=CHUNK){ chunks.push(records.slice(i,i+CHUNK)); }

  const nsBase='http://www.sitemaps.org/schemas/sitemap/0.9';

  const urlsetOpen = ()=> `<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="${nsBase}">\n`;
  const urlEntry = it => {
    let xml = `  <url>\n    <loc>${escapeXml(it.url)}</loc>\n`;
    if(it.changefreq) xml+=`    <changefreq>${escapeXml(it.changefreq)}</changefreq>\n`;
    xml+=`  </url>\n`; 
    return xml;
  };

  const files=[];
  for(let i=0;i<chunks.length;i++){
    let xml=urlsetOpen(); for(const it of chunks[i]) xml+=urlEntry(it); xml+='</urlset>\n';
    const name = (chunks.length===1) ? 'sitemap.xml' : `sitemap-${i+1}.xml`;
    files.push({name, xml});
  }

  // فهرس (lastmod فقط على مستوى الفهرس)
  let indexXml='';
  const root = 'https://example.com/'; /* لا تغيّر الإعدادات */
  if(files.length>1){
    indexXml = `<?xml version="1.0" encoding="UTF-8"?>\n<sitemapindex xmlns="${nsBase}">\n`;
    const last = new Date().toISOString().slice(0,10);
    for(const f of files){
      indexXml += `  <sitemap>\n    <loc>${escapeXml(root+f.name)}</loc>\n    <lastmod>${last}</lastmod>\n  </sitemap>\n`;
    }
    indexXml += `</sitemapindex>\n`;
    files.push({name:'sitemap_index.xml', xml:indexXml});
  }else{
    const last=new Date().toISOString().slice(0,10);
    indexXml = `<?xml version="1.0" encoding="UTF-8"?>\n<sitemapindex xmlns="${nsBase}">\n  <sitemap>\n    <loc>${escapeXml(root+files[0].name)}</loc>\n    <lastmod>${last}</lastmod>\n  </sitemap>\n</sitemapindex>\n`;
  }

  const approxSize = files.reduce((s,f)=> s + new TextEncoder().encode(f.xml).length, 0);
  return {files, indexXml, count: records.length, approxSize, errors};
}

/* ---- ZIP (Stored) ---- */
const CRC_TABLE = (()=>{ const t=new Uint32Array(256); for(let n=0;n<256;n++){ let c=n; for(let k=0;k<8;k++){ c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);} t[n]=c>>>0;} return t;})();
const crc32 = bytes => { let c=0^(-1); for(let i=0;i<bytes.length;i++){ c=(c>>>8)^CRC_TABLE[(c^bytes[i])&0xFF]; } return (c^(-1))>>>0; };
function dosTimeDate(d=new Date()){ return { time:(d.getHours()<<11)|(d.getMinutes()<<5)|(Math.floor(d.getSeconds()/2)), date:(((d.getFullYear()-1980)&0x7F)<<9)|((d.getMonth()+1)<<5)|d.getDate() }; }
function buildZipBlob(files){
  const now=new Date(); const {time,date}=dosTimeDate(now);
  let total=0, offsets=[];
  for(const f of files){ const nb=new TextEncoder().encode(f.name); offsets.push(total); total+=30+nb.length+f.data.length; }
  let cd=0; for(const f of files){ cd += 46 + new TextEncoder().encode(f.name).length; }
  const eocd=22; const buf=new ArrayBuffer(total+cd+eocd); const view=new DataView(buf); const u8=new Uint8Array(buf);
  let p=0; const recs=[];
  for(let i=0;i<files.length;i++){
    const f=files[i], nb=new TextEncoder().encode(f.name), data=f.data, crc=crc32(data);
    view.setUint32(p,0x04034b50,true); p+=4; view.setUint16(p,20,true); p+=2; view.setUint16(p,0,true); p+=2; view.setUint16(p,0,true); p+=2;
    view.setUint16(p,time,true); p+=2; view.setUint16(p,date,true); p+=2; view.setUint32(p,crc,true); p+=4; view.setUint32(p,data.length,true); p+=4; view.setUint32(p,data.length,true); p+=4;
    view.setUint16(p,nb.length,true); p+=2; view.setUint16(p,0,true); p+=2; u8.set(nb,p); p+=nb.length; u8.set(data,p); p+=data.length;
    recs.push({nb,crc,size:data.length,off:offsets[i]});
  }
  const cdStart=p;
  for(const r of recs){
    view.setUint32(p,0x02014b50,true); p+=4; view.setUint16(p,20,true); p+=2; view.setUint16(p,20,true); p+=2; view.setUint16(p,0,true); p+=2; view.setUint16(p,0,true); p+=2;
    view.setUint16(p,time,true); p+=2; view.setUint16(p,date,true); p+=2; view.setUint32(p,r.crc,true); p+=4; view.setUint32(p,r.size,true); p+=4; view.setUint32(p,r.size,true); p+=4;
    view.setUint16(p,r.nb.length,true); p+=2; view.setUint16(p,0,true); p+=2; view.setUint16(p,0,true); p+=2; view.setUint16(p,0,true); p+=2; view.setUint16(p,0,true); p+=2; view.setUint32(p,0,true); p+=4; view.setUint32(p,r.off,true); p+=4; u8.set(r.nb,p); p+=r.nb.length;
  }
  const cdEnd=p;
  view.setUint32(p,0x06054b50,true); p+=4; view.setUint16(p,0,true); p+=2; view.setUint16(p,0,true); p+=2; view.setUint16(p,files.length,true); p+=2; view.setUint16(p,files.length,true); p+=2; view.setUint32(p,cdEnd-cdStart,true); p+=4; view.setUint32(p,cdStart,true); p+=4; view.setUint16(p,0,true); p+=2;
  return new Blob([u8], {type:'application/zip'});
}

/* ---- تنزيل ---- */
function downloadBlob(blob, filename){
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click();
  URL.revokeObjectURL(a.href); a.remove();
}

/* ---- التوليد والمعاينة ---- */
let lastBuild=null;
function updateAll(){
  const {files, indexXml, count, approxSize, errors} = buildSitemaps();
  lastBuild = {files, indexXml};
  links.innerHTML='';
  if(errors.length){
    errorsBox.style.display='block';
    errorsBox.innerHTML = 'ملاحظات:<br>- ' + errors.map(e=>escapeXml(e)).join('<br>- ');
  }else{
    errorsBox.style.display='none'; errorsBox.textContent='';
  }

  sumCount.textContent = String(count);
  sumFiles.textContent = String(files.length);
  sumSize.textContent = (approxSize/1024).toFixed(1) + ' KB';

  if(files.length){
    const first = files[0].xml;
    code.innerHTML = highlightXml(first.slice(0,6000));
    for(const f of files){
      const a=document.createElement('a');
      a.href = URL.createObjectURL(new Blob([f.xml],{type:'application/xml'}));
      a.download = f.name;
      a.textContent = `تنزيل ${f.name}`;
      a.className = 'btn';
      a.style.margin='6px 6px 0 0';
      links.appendChild(a);
    }
  }else{
    code.textContent=''; links.textContent='لا يوجد ملفات بعد.';
  }

  btnZip.disabled = files.length===0;
  btnCopyIndex.disabled = files.length===0;
}
updateAll();

btnCopyIndex.addEventListener('click', async ()=>{
  if(!lastBuild) return;
  try{
    await navigator.clipboard.writeText(lastBuild.indexXml||'');
    btnCopyIndex.textContent='تم النسخ ✓';
    setTimeout(()=> btnCopyIndex.textContent='نسخ sitemap_index.xml', 1200);
  }catch{
    const w=window.open(); if(w){ w.document.write('<pre>'+escapeXml(lastBuild.indexXml||'')+'</pre>'); w.document.close(); }
  }
});
btnZip.addEventListener('click', ()=>{
  if(!lastBuild || !lastBuild.files.length) return;
  const files = lastBuild.files.map(f=>({name:f.name, data: toBytes(f.xml)}));
  const now=new Date();
  const ts = now.getFullYear().toString()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
  const blob = buildZipBlob(files);
  downloadBlob(blob, `sitemaps-${ts}.zip`);
});

/* ---- تمييز XML ---- */
function highlightXml(xml){
  const esc = escapeXml(xml);
  return esc
    .replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="cm">$1</span>')
    .replace(/(&lt;\/?)([a-zA-Z0-9:.-]+)([^&]*?&gt;)/g, (m,p1,tag,rest)=>{
      const attrs = rest.replace(/\s([a-zA-Z0-9:-]+)=(&quot;.*?&quot;|&apos;.*?&apos;)/g,(m2,a,v)=>` <span class="attr">${a}</span>=<span class="val">${v}</span>`);
      return `<span class="tag">${p1}${tag}</span>${attrs}`;
    });
}
</script>
</body>
</html>
